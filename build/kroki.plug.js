var J=Object.defineProperty;var X=(e,t)=>{for(var r in t)J(e,r,{get:t[r],enumerable:!0})};function m(e){let t=atob(e),r=t.length,a=new Uint8Array(r);for(let o=0;o<r;o++)a[o]=t.charCodeAt(o);return a}function l(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",r=e.byteLength;for(let a=0;a<r;a++)t+=String.fromCharCode(e[a]);return btoa(t)}var Be=new Uint8Array(16);var k=class{prefix;maxCaptureSize;originalConsole;logBuffer;constructor(t="",r=1e3){this.prefix=t,this.maxCaptureSize=r,this.logBuffer=[],this.prefix=t,this.originalConsole={log:console.log.bind(console),info:console.info.bind(console),warn:console.warn.bind(console),error:console.error.bind(console),debug:console.debug.bind(console)},this.patchConsole()}patchConsole(){let t=r=>(...a)=>{let o=this.prefix?[this.prefix,...a]:a;this.originalConsole[r](...o),this.captureLog(r,a)};console.log=t("log"),console.info=t("info"),console.warn=t("warn"),console.error=t("error"),console.debug=t("debug")}captureLog(t,r){let a={level:t,timestamp:Date.now(),message:r.map(o=>{if(typeof o=="string")return o;try{return JSON.stringify(o)}catch{return String(o)}}).join(" ")};this.logBuffer.push(a),this.logBuffer.length>this.maxCaptureSize&&this.logBuffer.shift()}async postToServer(t,r){if(this.logBuffer.length>0){let o=[...this.logBuffer];this.logBuffer=[];try{if(!(await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o.map(c=>({...c,source:r})))})).ok)throw new Error("Failed to post logs to server")}catch(s){console.warn("Could not post logs to server",s.message),this.logBuffer.unshift(...o)}}}},y;function x(e=""){return y=new k(e),y}var d=e=>{throw new Error("Not initialized yet")},f=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var p=new Map,g=0;f&&(globalThis.syscall=async(e,...t)=>await new Promise((r,a)=>{g++,p.set(g,{resolve:r,reject:a}),d({type:"sys",id:g,name:e,args:t})}));function W(e,t,r){f&&(d=r,self.addEventListener("message",a=>{(async()=>{let o=a.data;switch(o.type){case"inv":{let s=e[o.name];if(!s)throw new Error(`Function not loaded: ${o.name}`);try{let c=await Promise.resolve(s(...o.args||[]));d({type:"invr",id:o.id,result:c})}catch(c){console.error("An exception was thrown as a result of invoking function",o.name,"error:",c.message),d({type:"invr",id:o.id,error:c.message})}}break;case"sysr":{let s=o.id,c=p.get(s);if(!c)throw Error("Invalid request id");p.delete(s),o.error?c.reject(new Error(o.error)):c.resolve(o.result)}break}})().catch(console.error)}),d({type:"manifest",manifest:t}),x(`[${t.name} plug]`))}async function Y(e,t){if(typeof e!="string"){let r=new Uint8Array(await e.arrayBuffer()),a=r.length>0?l(r):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:a},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function Z(){globalThis.fetch=async function(e,t){let r=t&&t.body?l(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,a=await Y(e,t&&{method:t.method,headers:t.headers,base64Body:r});return new Response(a.base64Body?m(a.base64Body):null,{status:a.status,headers:a.headers})}}f&&Z();typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function i(e,...t){return globalThis.syscall(e,...t)}var u={};X(u,{cleanDatabases:()=>pe,getBaseURI:()=>ue,getConfig:()=>ke,getMode:()=>ce,getURLPrefix:()=>de,getVersion:()=>le,invokeCommand:()=>ie,invokeFunction:()=>oe,listCommands:()=>ne,listSyscalls:()=>ae,reloadPlugs:()=>se,wipeClient:()=>ge});function oe(e,...t){return i("system.invokeFunction",e,...t)}function ie(e,t){return i("system.invokeCommand",e,t)}function ne(){return i("system.listCommands")}function ae(){return i("system.listSyscalls")}function se(){return i("system.reloadPlugs")}function ce(){return i("system.getMode")}function de(){return i("system.getURLPrefix")}function ue(){return i("system.getBaseURI")}function le(){return i("system.getVersion")}function ke(e,t=void 0){return i("system.getConfig",e,t)}function ge(e=!1){return i("system.wipeClient",e)}function pe(){return i("system.cleanDatabases")}var Oe=new Uint8Array(16);async function n(e,t){let o=`${(await u.getConfig("kroki",{server:"https://kroki.io"}))?.server||"https://kroki.io"}/${t}/svg`;console.log(`krokiWidget: Sending request to ${o} with body:`,e);let s=await Ee(o,e);return{html:`<pre id="${t}">${s}</pre>`,script:`
    document.addEventListener("click", () => {
      api({type: "blur"});
    });
    `}}async function Ee(e,t){let r=await fetch(e,{method:"POST",headers:{"Content-Type":"text/plain"},body:t});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return await r.text()}async function h(e,t){return console.log("krokiBlockdiagWidget called with bodyText:",e),n(e,"blockdiag")}async function w(e,t){return console.log("krokiBpmnWidget called with bodyText:",e),n(e,"bpmn")}async function b(e,t){return console.log("krokiBytefieldWidget called with bodyText:",e),n(e,"bytefield")}async function v(e,t){return console.log("krokiSeqdiagWidget called with bodyText:",e),n(e,"seqdiag")}async function S(e,t){return console.log("krokiActdiagWidget called with bodyText:",e),n(e,"actdiag")}async function P(e,t){return console.log("krokiNwdiagWidget called with bodyText:",e),n(e,"nwdiag")}async function C(e,t){return console.log("krokiPacketdiagWidget called with bodyText:",e),n(e,"packetdiag")}async function A(e,t){return console.log("krokiRackdiagWidget called with bodyText:",e),n(e,"rackdiag")}async function E(e,t){return console.log("krokiC4plantumlWidget called with bodyText:",e),n(e,"c4plantuml")}async function D(e,t){return console.log("krokiD2Widget called with bodyText:",e),n(e,"d2")}async function B(e,t){return console.log("krokiDbmlWidget called with bodyText:",e),n(e,"dbml")}async function T(e,t){return console.log("krokiDitaaWidget called with bodyText:",e),n(e,"ditaa")}async function N(e,t){return console.log("krokiErdWidget called with bodyText:",e),n(e,"erd")}async function U(e,t){return console.log("krokiExcalidrawWidget called with bodyText:",e),n(e,"excalidraw")}async function M(e,t){return console.log("krokiGraphvizWidget called with bodyText:",e),n(e,"graphviz")}async function F(e,t){return console.log("krokiMermaidWidget called with bodyText:",e),n(e,"mermaid")}async function z(e,t){return console.log("krokiNomnomlWidget called with bodyText:",e),n(e,"nomnoml")}async function R(e,t){return console.log("krokiPikchrWidget called with bodyText:",e),n(e,"pikchr")}async function L(e,t){return console.log("krokiPumlWidget called with bodyText:",e),n(e,"plantuml")}async function _(e,t){return console.log("krokiStructurizrWidget called with bodyText:",e),n(e,"structurizr")}async function K(e,t){return console.log("krokiSvgbobWidget called with bodyText:",e),n(e,"svgbob")}async function q(e,t){return console.log("krokiSymbolatorWidget called with bodyText:",e),n(e,"symbolator")}async function $(e,t){return console.log("krokiTikzWidget called with bodyText:",e),n(e,"tikz")}async function G(e,t){return console.log("krokiUmletWidget called with bodyText:",e),n(e,"umlet")}async function V(e,t){return console.log("krokiVegaWidget called with bodyText:",e),n(e,"vega")}async function O(e,t){return console.log("krokiVegaLiteWidget called with bodyText:",e),n(e,"vega-lite")}async function j(e,t){return console.log("krokiWavedromWidget called with bodyText:",e),n(e,"wavedrom")}async function H(e,t){return console.log("krokiWirevizWidget called with bodyText:",e),n(e,"wireviz")}var Q={krokiBlockdiagWidget:h,krokiBpmnWidget:w,krokiBytefieldWidget:b,krokiSeqdiagWidget:v,krokiActdiagWidget:S,krokiNwdiagWidget:P,krokiPacketdiagWidget:C,krokiRackdiagWidget:A,krokiC4plantumlWidget:E,krokiD2Widget:D,krokiDbmlWidget:B,krokiDitaaWidget:T,krokiErdWidget:N,krokiExcalidrawWidget:U,krokiGraphvizWidget:M,krokiMermaidWidget:F,krokiNomnomlWidget:z,krokiPikchrWidget:R,krokiPumlWidget:L,krokiStructurizrWidget:_,krokiSvgbobWidget:K,krokiSymbolatorWidget:q,krokiTikzWidget:$,krokiUmletWidget:G,krokiVegaWidget:V,krokiVegaLiteWidget:O,krokiWavedromWidget:j,krokiWirevizWidget:H},I={name:"kroki",version:.1,imports:["https://get.silverbullet.md/global.plug.json"],requiredPermissions:["fetch"],functions:{krokiBlockdiagWidget:{path:"./kroki.ts:krokiBlockdiagWidget",codeWidget:"kroki_blockdiag"},krokiBpmnWidget:{path:"./kroki.ts:krokiBpmnWidget",codeWidget:"kroki_bpmn"},krokiBytefieldWidget:{path:"./kroki.ts:krokiBytefieldWidget",codeWidget:"kroki_bytefield"},krokiSeqdiagWidget:{path:"./kroki.ts:krokiSeqdiagWidget",codeWidget:"kroki_seqdiag"},krokiActdiagWidget:{path:"./kroki.ts:krokiActdiagWidget",codeWidget:"kroki_actdiag"},krokiNwdiagWidget:{path:"./kroki.ts:krokiNwdiagWidget",codeWidget:"kroki_nwdiag"},krokiPacketdiagWidget:{path:"./kroki.ts:krokiPacketdiagWidget",codeWidget:"kroki_packetdiag"},krokiRackdiagWidget:{path:"./kroki.ts:krokiRackdiagWidget",codeWidget:"kroki_rackdiag"},krokiC4plantumlWidget:{path:"./kroki.ts:krokiC4plantumlWidget",codeWidget:"kroki_c4plantuml"},krokiD2Widget:{path:"./kroki.ts:krokiD2Widget",codeWidget:"kroki_d2"},krokiDbmlWidget:{path:"./kroki.ts:krokiDbmlWidget",codeWidget:"kroki_dbml"},krokiDitaaWidget:{path:"./kroki.ts:krokiDitaaWidget",codeWidget:"kroki_ditaa"},krokiErdWidget:{path:"./kroki.ts:krokiErdWidget",codeWidget:"kroki_erd"},krokiExcalidrawWidget:{path:"./kroki.ts:krokiExcalidrawWidget",codeWidget:"kroki_excalidraw"},krokiGraphvizWidget:{path:"./kroki.ts:krokiGraphvizWidget",codeWidget:"kroki_graphviz"},krokiMermaidWidget:{path:"./kroki.ts:krokiMermaidWidget",codeWidget:"kroki_mermaid"},krokiNomnomlWidget:{path:"./kroki.ts:krokiNomnomlWidget",codeWidget:"kroki_nomnoml"},krokiPikchrWidget:{path:"./kroki.ts:krokiPikchrWidget",codeWidget:"kroki_pikchr"},krokiPumlWidget:{path:"./kroki.ts:krokiPumlWidget",codeWidget:"kroki_puml"},krokiStructurizrWidget:{path:"./kroki.ts:krokiStructurizrWidget",codeWidget:"kroki_structurizr"},krokiSvgbobWidget:{path:"./kroki.ts:krokiSvgbobWidget",codeWidget:"kroki_svgbob"},krokiSymbolatorWidget:{path:"./kroki.ts:krokiSymbolatorWidget",codeWidget:"kroki_symbolator"},krokiTikzWidget:{path:"./kroki.ts:krokiTikzWidget",codeWidget:"kroki_tikz"},krokiUmletWidget:{path:"./kroki.ts:krokiUmletWidget",codeWidget:"kroki_umlet"},krokiVegaWidget:{path:"./kroki.ts:krokiVegaWidget",codeWidget:"kroki_vega"},krokiVegaLiteWidget:{path:"./kroki.ts:krokiVegaLiteWidget",codeWidget:"kroki_vega-lite"},krokiWavedromWidget:{path:"./kroki.ts:krokiWavedromWidget",codeWidget:"kroki_wavedrom"},krokiWirevizWidget:{path:"./kroki.ts:krokiWirevizWidget",codeWidget:"kroki_wireviz"}},assets:{}},_t={manifest:I,functionMapping:Q};W(Q,I,self.postMessage);export{_t as plug};
//# sourceMappingURL=kroki.plug.js.map
